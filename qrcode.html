<!DOCTYPE html>
<html>

<head>
    <title>QR Scanner</title>
</head>

<body>
    <span id="text">

    </span>
    <video id="qr-video"></video>
    <select id="cam-list" value="">
        <option value="environment" selected>Environment Facing (default)</option>
        <option value="user">User Facing</option>
    </select>
    <div id="scan-again">
        <span id="done">
            ✔
        </span>
        <span id="error">
            ✖
        </span>
        <button id="btn-scan-again">
            Scan again
        </button>
    </div>
    <script type="module">
        import QrScanner from "https://nimiq.github.io/qr-scanner/qr-scanner.min.js";

        // document.getElementById('result').style.color = 'blue'
        const videoElem = document.getElementById('qr-video')
        const camList = document.getElementById('cam-list')

        document.getElementById('btn-scan-again').addEventListener('click', () => {
            start()

            document.getElementById('scan-again').style.display = 'none'
        })

        const fetch = (result) => {
            var RegExp = /^((ftp|http|https):\/\/)?(www\.)?([A-Za-zА-Яа-я0-9]{1}[A-Za-zА-Яа-я0-9\-]*\.?)*\.{1}[A-Za-zА-Яа-я0-9-]{2,8}(\/([\w#!:.?+=&%@!\-\/])*)?/;
            document.getElementById('text').innerText = result
        }

        // const resultFetch = (url) => {
        //     if (url?.data) {
        //         await fetch(url.data, {
        //             method: 'POST',
        //             headers: {
        //                 'Accept': 'application/json',
        //                 'Content-Type': 'application/json'
        //             },
        //             body: JSON.stringify({
        //                 sign: 123,
        //                 name: 'test'
        //             })
        //         }).then(r => {
        //             qrScanner.stop();
        //             videoElem.style.display = 'none'
        //             document.getElementById('scan-again').style.display = 'flex'
        //             if (r.status === 200) {
        //                 document.querySelector('body').style.backgroundColor = 'green'
        //                 document.getElementById('done').style.display = 'block'
        //             } else {
        //                 document.querySelector('body').style.backgroundColor = 'red'
        //                 document.getElementById('error').style.display = 'block'
        //             }
        //         })
        //     }
        // }

        const scanner = new QrScanner(videoElem, result => fetch(result), {
            highlightScanRegion: true,
            highlightCodeOutline: true,
        });

        scanner.start().then(() => {
            QrScanner.listCameras(true).then(cameras => cameras.forEach(camera => {
                const option = document.createElement('option')
                option.value = camera.id
                option.text = camera.label
                camList.add(option)
            }))
        })

        camList.addEventListener('change', event => {
            scanner.setCamera(event.target.value)
        })

        scanner.start()


    </script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            height: 100%;
        }

        body {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;

            position: relative;
        }

        #scan-again {
            display: none;
            flex-direction: column;


        }

        #done {
            display: none;
            font-size: 100px;

        }

        #error {
            display: none;
            font-size: 100px;
        }

        #qr-video {
            width: 100%;
            height: 100%;


            border: 2px dashed black;
            border-radius: 10px;
        }

        #cam-list {
            position: absolute;

            bottom: 0;
            left: 50%;
            transform: translate(-50%, -50%);

            font-size: 40px;

            border-radius: 15px;

            padding: 15px;
        }
    </style>
</body>

</html>